<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/qz-tray/qz-tray.js"></script>
  <title>Home Page with Search</title>
  <style>
    /* General styling */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f9f9f9;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #007bff;
      padding: 10px 20px;
      color: #fff;
    }

    .header h1 {
      margin: 0;
    }

    .header button {
      background: #ff4d4d;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .header button:hover {
      background: #e60000;
    }

    .main {
      display: flex;
      margin: 20px;
    }

    /* Product and Cart container widths */
    .products-container {
      flex: 70%;
      padding-right: 20px;
    }

    .cart-container {
      flex: 30%;
    }

    .search-bar {
      margin-bottom: 20px;
    }

    .search-bar input {
      width: 98%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .categories {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
    }

    .category {
      background: #007bff;
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      margin: 5px;
      cursor: pointer;
    }

    .category.active {
      background: #0056b3;
    }

    .products {
      display: grid;
      grid-template-columns: repeat(6, minmax(130px, 1fr));
      gap: 10px;
    }

    .product {
      background: #ffffff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .product h3 {
      margin: 0;
      font-size: 18px;
    }

    .product p {
      margin: 5px 0;
      color: #555;
    }

    .product .price {
      color: #007bff;
      font-weight: bold;
    }

    .cart {
      background: #ffffff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .cart h2 {
      margin: 0 0 10px;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }

    .cart-item:last-child {
      border-bottom: none;
    }

    .total {
      font-size: 18px;
      font-weight: bold;
      margin: 10px 0;
    }

    .actions {
      display: flex;
      justify-content: space-between;
    }

    .actions button {
      flex: 1;
      padding: 10px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .print-cost {
      background: #007bff;
      color: #fff;
    }

    .print-kot {
      background: #28a745;
      color: #fff;
    }

    .print-both {
      background: #ffca28;
      color: #000;
    }
  </style>
  <style>
    .cart-container {
  flex: 3;
  display: flex;
  flex-direction: column-reverse; /* Start content from the bottom */
  background: #fff;
  border-radius: 15px;
  box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.2);
  padding: 20px;
  height: 100%; /* Ensure it takes full height */
  overflow-y: auto; /* Scroll if items exceed container height */
}

.cart {
  display: flex;
  flex-direction: column;
  justify-content: flex-start; /* Items stack upward */
  gap: 10px;
}

.cart-item {
  display: flex;
  justify-content: space-between;
  margin: 5px 0;
  border-bottom: 1px solid #ddd;
  padding-bottom: 10px;
}

.cart-item:last-child {
  border-bottom: none;
}

.total {
  font-size: 18px;
  font-weight: bold;
  margin: 10px 0;
}

.actions {
  display: flex;
  gap: 10px;
}

.actions button {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
  transition: transform 0.2s, box-shadow 0.2s;
}

.actions button:hover {
  transform: scale(1.05);
  box-shadow: 0px 6px 12px rgba(0, 0, 0, 0.3);
}

  </style>
</head>
<body>
  <div class="header">
    <h1>Indian Coffee Shoppe</h1>
    <button>Logout</button>
  </div>

  <div class="main">
    <!-- Products Section -->
    <div class="products-container">
      <div class="search-bar">
        <input type="text" id="search" placeholder="Search for items...">
      </div>

      <div class="categories">
        <div class="category active" data-category="all">All</div>
        <div class="category" data-category="coffee">Coffee</div>
        <div class="category" data-category="milk">Milk</div>
        <div class="category" data-category="sandwich">Sandwich</div>
        <div class="category" data-category="chinese">Chinese</div>
      </div>

      <div class="products" id="product-list">
        <!-- Products will be loaded dynamically here -->
      </div>
    </div>

    <!-- Cart Section -->
    <div class="cart-container">
      <div class="cart">
        <h2>Shopping Cart</h2>
        <div id="cart-items">
          <!-- Cart items will appear here -->
        </div>
        <div class="total">Total: Rs. <span id="total-amount">0</span></div>
        <div class="actions">
          <button onclick="printWithDefaultPrinter('cust')" class="print-cost">Print Cost</button>
          <button onclick="printWithDefaultPrinter('kot')" class="print-kot">Print KOT</button>
          <button onclick="printWithDefaultPrinter('both')" class="print-both">Print Both</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const order_type = "Dine In"
    const products = [
      { id: 1, name: "Coffee ddd dgfd ffdd g  dg d", description: "Hot Coffee", price: 30, category: "coffee", unique_number:1, counter:1},
      { id: 2, name: "Cold Coffee", description: "Iced Coffee", price: 60, category: "coffee", unique_number:2, counter:1},
      { id: 3, name: "Milkshake", description: "Chocolate Milk", price: 50, category: "milk", unique_number:3, counter:2},
      { id: 4, name: "Sandwich", description: "Grilled Sandwich", price: 40, category: "sandwich", unique_number:4, counter:2},
      { id: 5, name: "Noodles", description: "Veg Noodles", price: 70, category: "chinese", unique_number:5, counter:1},
    ];

    const cart = [];
    let currentCategory = "all";

    function loadProducts(category = "all", searchQuery = "") {
      const productList = document.getElementById("product-list");
      productList.innerHTML = "";

      const filteredProducts = products.filter(p => {
        const matchesCategory = category === "all" || p.category === category;
        const matchesSearch = p.name.toLowerCase().includes(searchQuery.toLowerCase());
        return matchesCategory && matchesSearch;
      });

      filteredProducts.forEach(product => {
        const productCard = document.createElement("div");
        productCard.className = "product";
        productCard.innerHTML = `
        <div onclick="addToCart(${product.id})">
          <h3>${product.name}</h3>
          <p>${product.description}</p>
          <p class="price">Rs.${product.price}</p></div>
        `;
        productList.appendChild(productCard);
      });
    }

    function addToCart(productId) {
      const product = products.find(p => p.id === productId);
      const cartItem = cart.find(c => c.id === productId);
      if (cartItem) {
        cartItem.quantity += 1;
      } else {
        cart.push({ ...product, quantity: 1 });
      }
      updateCart();
    }

    function updateCart() {
      const cartItems = document.getElementById("cart-items");
      const totalAmount = document.getElementById("total-amount");
      cartItems.innerHTML = "";
      let total = 0;

      cart.forEach(item => {
        total += item.price * item.quantity;
        const cartRow = document.createElement("div");
        cartRow.className = "cart-item";
        cartRow.innerHTML = `
          <span>${item.name} x ${item.quantity}</span>
          <span>Rs.${item.price * item.quantity}</span>
        `;
        cartItems.appendChild(cartRow);
      });

      totalAmount.textContent = total;
    }

    document.querySelectorAll(".category").forEach(category => {
      category.addEventListener("click", () => {
        document.querySelectorAll(".category").forEach(cat => cat.classList.remove("active"));
        category.classList.add("active");
        currentCategory = category.getAttribute("data-category");
        loadProducts(currentCategory, document.getElementById("search").value);
      });
    });

    document.getElementById("search").addEventListener("input", (e) => {
      const searchQuery = e.target.value;
      loadProducts(currentCategory, searchQuery);
    });

    // Initial load
    loadProducts();
  </script>
  <script>
    // Start QZ Tray
    qz.websocket.connect().then(() => {
      console.log("QZ Tray Connected!");
    }).catch(console.error);

      function getPrintable(print_type){

        let totalQty = 0;
        let totalAmount = 0;
        const invoiceNumber = 12334+1;
        const orderNumber = 2+1;
        const paidBy = 'Cash';
        const shopDetails = '28, Stadium Market, Ratlam, GSTIN: 23AGDPP8260G1ZF';

        let cust = [];
        let kot = [];
        const lastReciept = 3234223+1;//need to fetch
        const lastOrder = 23+1;//need to fetch
        if (print_type == 'cust' || print_type == 'both'){
          cust = [
                    '\x1B\x40', // Initialize printer
                    '\x1B\x61\x01', // Center alignment
                    '\x1B\x21\x30', // Bold text, 2x width, 2x height
                    'Indian Coffee Shoppe\n',
                    '\x1B\x21\x00', // Normal text
                    `Order Type: ${order_type}\n`,
                    `${lastReciept} #${lastOrder}\n`,
                    `${new Date().toLocaleString()}\n\n`,
                    '\x1B\x61\x00', // Left alignment
                    '-----------------------------------------------\n',
                    'Item                        Rate    Qty  Amount\n',
                    '-----------------------------------------------\n',
                ];
                  // Add items dynamically
                  cart.forEach((item) => {
                    const name = item.name.length > 24 ? item.name.slice(0, 24) : item.name.padEnd(24);
                    const rate = item.price.toFixed(0).padStart(6);
                    const quantity = item.quantity.toString().padStart(5);
                    const amount = (item.price * item.quantity).toFixed(0).padStart(7);
                    totalQty += parseInt(quantity)
                    totalAmount += parseFloat(amount)
                    const line = `${name} ${rate} ${quantity} ${amount}\n`;
                    cust.push(line);
                    if(item.details) cust.push(`${item.details}\n`);
                  });

                  cust.push('-----------------------------------------------\n');
                  cust.push(`\x1D\x21\x11`);
                  cust.push(`Total Qty: ${totalQty}\n`);
                  cust.push(`Total Amount: ${totalAmount}\n`);
                  cust.push('\n');
                  cust.push('-----------------------------------------------\n');
                  cust.push('\x1B\x61\x01'); // Center alignment
                  cust.push('\x1B\x21\x00'); // Normal text
                  cust.push('Thanks Do Visit Again Indian Coffee Shoppe (ICS)\n');
                  cust.push(`\x1D\x21\x11`);
                  cust.push(`${shopDetails}\n`);
                  cust.push('\n\x1B\x64\x02'); // Feed 2 lines
                  cust.push('\x1D\x56\x41');  // Full cut
                  cust.push('\x1A\x61\x00');  // Full cut
        }
        if(print_type == 'kot' || print_type == 'both'){
            const counterType = [...new Set(cart.map((item) => item.counter))];
// console.log(counterType,'counterType')
            counterType.forEach((c_type) => {
              const kotin = [
                  '\x1B\x40', // Initialize printer
                  '\x1B\x61\x01', // Center alignment
                  '\x1B\x21\x30', // Bold text, 2x width, 2x height
                  `Counter ${c_type}\n`,
                  '\x1B\x21\x00', // Normal text
                  `${new Date().toLocaleString()}\n\n`,
                  `Order #${lastOrder}\n`,
                  '\x1B\x61\x00', // Left alignment
                  '-----------------------------------------------\n',
                  'Item                                       Qty \n',
                  '-----------------------------------------------\n',
              ];
              cart.forEach((item) => {
                  if(c_type == item.counter){
                      const name = item.name.length > 41 ? item.name.slice(0, 41) : item.name.padEnd(41);
                      const quantity = item.quantity.toString().padStart(3);
                      const line = `${name} ${quantity}\n`;
                      kotin.push(line);
                      
                  }
              });
              kotin.push('-----------------------------------------------\n');
              kotin.push('\x1D\x56\x41');  // Full cut
              kotin.push('\x1A\x61\x00');  // Full cut
              // console.log(kotin,'kotin')
              // kot.concat(kotin)
              kot = [...kot, ...kotin]
            });
            console.log(kot,'kot')

        }
        return [...cust, ...kot]
                  
      }
      // Step 2: Print Test using ESC/POS commands
      function printWithDefaultPrinter(print_type) {

        const printData = getPrintable(print_type)
        // console.log(printData,'printData')
          // Set configuration for the default printer
          qz.printers.getDefault()
              .then(printer => {
                
                   
                  const config = qz.configs.create(printer); // Use the default printer

                  // Send the print job to the default printer
                  qz.print(config, printData)
                    .then(() => {
                        console.log("Order sent successfully!");
                        alert("Order sent successfully!");
                    })
                    .catch(err => {
                        console.error("Failed to print:", err);
                        alert("Failed to print. Ensure QZ Tray is running and the printer is connected.");
                  });
              })
              .catch(err => {
                  console.error("Failed to get the default printer:", err);
                  alert("Failed to get the default printer. Make sure your printer is set as the default.");
              });
      }


      // Optional: Disconnect from QZ Tray when page is unloaded
      window.addEventListener("beforeunload", () => {
          qz.websocket.disconnect().then(() => {
              console.log("Disconnected from QZ Tray");
          }).catch(err => {
              console.error("Failed to disconnect from QZ Tray:", err);
          });
      });
  </script>
</body>
</html>
